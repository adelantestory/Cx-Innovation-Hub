name: Deploy to Azure

on:
  push:
    branches: [ main, feature/dev-docker-azure-deployment ]
  workflow_dispatch:  # Allows manual triggering from GitHub UI

permissions:
  contents: read
  id-token: write

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
  BACKEND_CONTAINER_APP: ${{ secrets.BACKEND_CONTAINER_APP }}
  FRONTEND_CONTAINER_APP: ${{ secrets.FRONTEND_CONTAINER_APP }}

jobs:
  build-backend:
    name: Build & Push Backend Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract commit SHA (short)
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/taskify-backend:${{ steps.vars.outputs.sha_short }}
            ${{ secrets.ACR_LOGIN_SERVER }}/taskify-backend:latest
          cache-from: type=registry,ref=${{ secrets.ACR_LOGIN_SERVER }}/taskify-backend:latest
          cache-to: type=inline

  build-frontend:
    name: Build & Push Frontend Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract commit SHA (short)
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          build-args: |
            VITE_API_URL=${{ secrets.VITE_API_URL }}
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/taskify-frontend:${{ steps.vars.outputs.sha_short }}
            ${{ secrets.ACR_LOGIN_SERVER }}/taskify-frontend:latest
          cache-from: type=registry,ref=${{ secrets.ACR_LOGIN_SERVER }}/taskify-frontend:latest
          cache-to: type=inline

  deploy-backend:
    name: Deploy Backend to Azure
    runs-on: ubuntu-latest
    needs: [build-backend]  # Wait for backend image to be built

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Extract commit SHA (short)
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Run Database Migrations
        run: |
          cd backend
          npm ci
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Deploy Backend Container App
        run: |
          az containerapp update \
            --name ${{ env.BACKEND_CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/taskify-backend:${{ steps.vars.outputs.sha_short }} \
            --set-env-vars \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              AZURE_AI_ENDPOINT="${{ secrets.AZURE_AI_ENDPOINT }}" \
              AZURE_AGENT_NAME="${{ secrets.AZURE_AGENT_NAME }}" \
              CORS_ORIGIN="${{ secrets.CORS_ORIGIN }}"

      - name: Verify Backend Deployment
        run: |
          echo "âœ… Backend deployed successfully!"
          echo "Image: ${{ env.ACR_LOGIN_SERVER }}/taskify-backend:${{ steps.vars.outputs.sha_short }}"

  deploy-frontend:
    name: Deploy Frontend to Azure
    runs-on: ubuntu-latest
    needs: [build-frontend]  # Wait for frontend image to be built

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Extract commit SHA (short)
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Deploy Frontend Container App
        run: |
          az containerapp update \
            --name ${{ env.FRONTEND_CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/taskify-frontend:${{ steps.vars.outputs.sha_short }}

      - name: Verify Frontend Deployment
        run: |
          echo "âœ… Frontend deployed successfully!"
          echo "Image: ${{ env.ACR_LOGIN_SERVER }}/taskify-frontend:${{ steps.vars.outputs.sha_short }}"
          echo ""
          echo "ðŸš€ Deployment Complete!"
          echo "Both backend and frontend have been deployed to Azure Container Apps."

